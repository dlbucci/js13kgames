import*as e from"three";import{inRange as t,onFrame as n}from"./util.js";import{textures as o}from"./textures.js";export function initVR(s,r,a,i){const l=document.getElementById("vr");var p=null;const u=new e.Raycaster,v=new e.MeshStandardMaterial({color:"#FFF",transparent:!0,opacity:.7}),d=new e.Mesh(new e.TorusGeometry(.05,.01,4,20),v);d.position.z=-2,d.visible=!1,a.add(d);const m=new e.Mesh(new e.TorusGeometry(.05,.005,4,20),v);m.scale.set(2,2,2),m.position.z=-2,m.visible=!1,a.add(m);const c=new e.MeshStandardMaterial({color:"#FFF",map:o.arrow(),bumpMap:o.arrow(),bumpScale:3,transparent:!0,opacity:.5}),x=new e.Group;[{n:"_d",x:1,y:0,r:-1},{n:"_a",x:-1,y:0,r:1},{n:"_w",x:0,y:-1,r:0},{n:"_s",x:0,y:1,r:2}].forEach(t=>{const n=new e.Mesh(new e.BoxGeometry(.1,.05,.1),c);n.name=t.n,n.position.set(.125*t.x,0,.125*t.y),n.rotation.set(0,3.14*t.r/2,0),x.add(n)}),x.visible=!1,x.position.set(0,1.4,-.5),x.rotation.set(3.14/3,0,0),a.parent.add(x);var b=null,w=0;const y=()=>{l.textContent="No VR Found"},_=e=>{(p=e).addEventListener("end",f),s.xr.setSession(p),d.visible=!0,m.visible=!0,x.visible=!0,n(F)},f=()=>{d.visible=!1,m.visible=!1,x.visible=!1,a.lookAt(0,3,0),p=null},h=()=>{null===p?navigator.xr.requestSession("immersive-vr",{optionalFeatures:["local-floor"]}).then(_):p.end()},F=(e,o)=>{if(p){var s=null,l=!1;for(let e of p.inputSources){const t=e.gamepad;t&&(l=t.buttons[0].value>.5||t.buttons[1].pressed||t.buttons[2].pressed,t.axes[0]>.5&&(s="_d"),t.axes[0]<-.5&&(s="_a"),t.axes[1]>.5&&(s="_w"),t.axes[1]<-.5&&(s="_s"))}u.setFromCamera({x:0,y:0},a);for(var v=u.intersectObject(r.parent,!0),d=v[0]?.object;d&&(!d.name||d?.passDown);)d=d.parent;if(d?.name.startsWith("_")&&(s=d.name,d=null),d)if(d==b){m.visible=!0;var c=(e-w)/3e3;l&&(c=1.1);var x=4.8-4*c;m.scale.set(x,x,x),c>1&&(b=null,i(d,d?.name))}else b=d,w=e;else m.visible=!1,b=null;"_d"==s&&(r.rotation.y-=3e-4*o),"_a"==s&&(r.rotation.y+=3e-4*o),"_w"==s&&(r.rotation.x=t(-.1,1,r.rotation.x+2e-4*o)),"_s"==s&&(r.rotation.x=t(-.1,1,r.rotation.x-2e-4*o)),n(F)}};"xr"in navigator?navigator.xr.isSessionSupported("immersive-vr").then(e=>{e?l.onclick=h:y()}):y()}