import*as e from"three";import{wObj as t}from"./objects.js";import{initMouse as n}from"./mouse.js";import{levF as o}from"./levels.js";import{callEachFrame as s,siso as r,inter as i,si as d,so as a,frame as c,setLC as p}from"./util.js";import{initVR as m}from"./vr.js";import{sFX as l,pChimes as w}from"./sounds.js";function f(t){const n=o[t](),s=new e.Object3D,r={},i=n.obj;return i.forEach(t=>((t,n,o,i=[])=>{const d=new e.Object3D;d.name=t,n.p_adds&&Object.assign(d,n.p_adds),Object.assign(d,o?.add),d.position.set(o.x??0,o.y??0,o.z??0),d.rotation.set(o.rx??0,o.ry??0,o.rz??0),n.children[0].scale.set(o.sx??o.s??1,o.sy??o.s??1,o.sz??o.s??1),d.add(n),(o.parent?r[o.parent].node:s).add(d),r[t]={node:n,st:o.is||0,rls:i},o.is&&u(r[t],1,0,o.is,0,1)})(t.n,t.g,t.p,t.r)),{ir:{x:n.irx||0,y:n.iry||0},ref:Number.isInteger(+t)?+t:-1,node:s,pieces:r,m:n.m}}const y=(e,t,n,o,s,r,d)=>{e.position.set(i(d,i(o,t.x,n.x),i(s,t.x,n.x),r),i(d,i(o,t.y,n.y),i(s,t.y,n.y),r),i(d,i(o,t.z,n.z),i(s,t.z,n.z),r)),e.rotation.set(i(d,i(o,t.rx,n.rx),i(s,t.rx,n.rx),r),i(d,i(o,t.ry,n.ry),i(s,t.ry,n.ry),r),i(d,i(o,t.rz,n.rz),i(s,t.rz,n.rz),r))},u=(e,t,n,o,r,i,d,a)=>{s(t,t=>{y(e.node,e.node.sts[n],e.node.sts[o],r,i,d,t),e.node.bits.forEach(e=>{e.sts&&y(e.node,e.sts[n],e.sts[o],r,i,d,t)})},a)};export function makeWorld(){const o=new e.WebGLRenderer({antialias:!0});o.xr.enabled=!0,o.setSize(window.innerWidth,window.innerHeight),o.shadowMap.enabled=!0,document.body.appendChild(o.domElement);const y=new e.Scene,h=new e.Group;y.add(h);const x=new e.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.1,1e3),z=new e.Group;z.position.set(0,3,30),z.add(x),y.add(z),x.position.set(0,1.7,0),x.lookAt(0,3,0),t(h),o.setAnimationLoop(function(e){c(e),o.render(y,x)}),window.addEventListener("resize",()=>{x.aspect=window.innerWidth/window.innerHeight,x.updateProjectionMatrix(),o.setSize(window.innerWidth,window.innerHeight)});var b=null,g=!1;function j(e){const t=()=>{(b=e).node.position.set(1e3,1e3,1e3),h.add(e.node),w(e.m),s(1e3,t=>{e.node.position.set(0,i(t,40,0,a),0)});var t=h.rotation.x,n=h.rotation.y;s(1200,e=>{h.rotation.set(i(e,t,b.ir.x,a),i(e,n,b.ir.y,a),0)},()=>{e.pieces.cat&&u(e.pieces.cat,2e3,0,1,0,1,a),g=!1})};g=!0,w(),b?s(1e3,e=>{b.node.position.set(0,i(e,0,50,a),0)},()=>{h.remove(b.node),function(e){!function e(t){if(t){for(;t.children.length>0;)e(t.children[0]);if(t.parent&&t.parent.remove(t),t.geometry&&t.geometry.dispose(),t.material){for(const e in t.material){const n=t.material[e];n&&n.isTexture&&n.dispose()}t.material.dispose()}}}(e.node)}(b),t()}):t()}j(f(100));const v=e=>{if(g)return;let t=e.node.sts,n=e.st,o=(n+1)%t.length;g=!0;var s=e.rls.filter(e=>e.st===o).reduce((e,t)=>t.con.every(e=>(Array.isArray(e.st)?e.st:[e.st]).includes(b.pieces[e.o].st))?e<t.res?e:t.res:e,1e4),i=t[o].d;s<1?(t[o].snd(i/1e3,i*s/1e3),u(e,i*s,n,o,0,s,d,()=>{l.bash(.5,1),setTimeout(()=>{t[n].snd(i/1e3,i*s/1e3),u(e,i*s,n,o,s,0,a,()=>{g=!1})},1e3)})):(t[o].snd(i/1e3,2*i/1e3),u(e,i,n,o,0,1,r,()=>{g=!1,10==s&&(b.ref>=0&&p(b.ref),l.yowl(2,2),u(b.pieces.cat,1e3,1,2,0,1,a,()=>{j(f(101))})),s>=100&&s<=300&&j(f(s-100)),e.st=o,e.node.wrapState&&o==t.length-1&&(e.st=0,u(e,1,o,0,0,1))}))};n(h,x,(e,t)=>{v(b.pieces[t])}),m(o,h,x,(e,t)=>{v(b.pieces[t])})}makeWorld();