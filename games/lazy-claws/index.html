<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>wat</title>
  <style>
    html,
    body {
      background-color: #000;
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #app {
      box-shadow: 0 0 1px #000;
    }
  </style>
  <script>
    // ZzFX - Zuper Zmall Zound Zynth v1.3.1 by Frank Force | https://github.com/KilledByAPixel/ZzFX
    zzfx = (...t) => zzfxP(zzfxG(...t))
    zzfxP = (...t) => { let e = zzfxX.createBufferSource(), f = zzfxX.createBuffer(t.length, t[0].length, zzfxR); t.map((d, i) => f.getChannelData(i).set(d)), e.buffer = f, e.connect(zzfxX.destination), e.start(); return e }
    zzfxG = (q = 1, k = .05, c = 220, e = 0, t = 0, u = .1, r = 0, F = 1, v = 0, z = 0, w = 0, A = 0, l = 0, B = 0, x = 0, G = 0, d = 0, y = 1, m = 0, C = 0) => { let b = 2 * Math.PI, H = v *= 500 * b / zzfxR ** 2, I = (0 < x ? 1 : -1) * b / 4, D = c *= (1 + 2 * k * Math.random() - k) * b / zzfxR, Z = [], g = 0, E = 0, a = 0, n = 1, J = 0, K = 0, f = 0, p, h; e = 99 + zzfxR * e; m *= zzfxR; t *= zzfxR; u *= zzfxR; d *= zzfxR; z *= 500 * b / zzfxR ** 3; x *= b / zzfxR; w *= b / zzfxR; A *= zzfxR; l = zzfxR * l | 0; for (h = e + m + t + u + d | 0; a < h; Z[a++] = f)++K % (100 * G | 0) || (f = r ? 1 < r ? 2 < r ? 3 < r ? Math.sin((g % b) ** 3) : Math.max(Math.min(Math.tan(g), 1), -1) : 1 - (2 * g / b % 2 + 2) % 2 : 1 - 4 * Math.abs(Math.round(g / b) - g / b) : Math.sin(g), f = (l ? 1 - C + C * Math.sin(2 * Math.PI * a / l) : 1) * (0 < f ? 1 : -1) * Math.abs(f) ** F * q * zzfxV * (a < e ? a / e : a < e + m ? 1 - (a - e) / m * (1 - y) : a < e + m + t ? y : a < h - d ? (h - a - d) / u * y : 0), f = d ? f / 2 + (d > a ? 0 : (a < h - d ? 1 : (h - a) / d) * Z[a - d | 0] / 2) : f), p = (c += v += z) * Math.sin(E * x - I), g += p - p * B * (1 - 1E9 * (Math.sin(a) + 1) % 2), E += p - p * B * (1 - 1E9 * (Math.sin(a) ** 2 + 1) % 2), n && ++n > A && (c += w, D += w, n = 0), !l || ++J % l || (c = D, v = H, n = n || 1); return Z }
    zzfxV = .3
    zzfxR = 44100
    zzfxX = new (window.AudioContext || webkitAudioContext);
    //! ZzFXM (v2.0.3) | (C) Keith Clark | MIT | https://github.com/keithclark/ZzFXM
    zzfxM = (n, f, t, e = 125) => { let l, o, z, r, g, h, x, a, u, c, d, i, m, p, G, M = 0, R = [], b = [], j = [], k = 0, q = 0, s = 1, v = {}, w = zzfxR / e * 60 >> 2; for (; s; k++)R = [s = a = d = m = 0], t.map((e, d) => { for (x = f[e][k] || [0, 0, 0], s |= !!f[e][k], G = m + (f[e][0].length - 2 - !a) * w, p = d == t.length - 1, o = 2, r = m; o < x.length + p; a = ++o) { for (g = x[o], u = o == x.length + p - 1 && p || c != (x[0] || 0) | g | 0, z = 0; z < w && a; z++ > w - 99 && u ? i += (i < 1) / 99 : 0)h = (1 - i) * R[M++] / 2 || 0, b[r] = (b[r] || 0) - h * q + h, j[r] = (j[r++] || 0) + h * q + h; g && (i = g % 1, q = x[1] || 0, (g |= 0) && (R = v[[c = x[M = 0] || 0, g]] = v[[c, g]] || (l = [...n[c]], l[2] *= 2 ** ((g - 12) / 12), g > 0 ? zzfxG(...l) : []))) } m = G }); return [b, j] }

    const buffer = zzfxM(...[[[.25,0,,,,,3,0,,,320,,,4],[.25,0,137,.02,.2,.55,2,.41,,,.1],[.25,0,84,,,,,.7,,,,.5,,6.7,1,.05],[.25,0,209,,.02,.25,3],[.25,0,800,,,.075,2,2,,,1e3,-.01,.02,4.8,-.3,,.065],[.25,0,219,,,,,1.1,,-.1,-50,-.05,-.01,1],[.25,0,52,,,.2,2,,,,.5,.01],[.25,0,22,,.07,.07,2,0,,,.5,.01]],[[[2,-1,20,,,,20,,,,20,,,,20,,,,20,,,,20,,,,20,,,,20,20,,20,20,,,,20,,,,20,,,,20,,,,20,,,,20,,,,20,20,,,20,20,20,20],[1,1,13,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,9,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,],[3,-1,13,13,16,8,16,13,20,16,8,4,8,16,13,20,25,13,13,13,16,8,16,13,20,16,8,4,8,16,13,20,25,13,9,9,16,9,4,9,21,16,21,25,23,21,28,25,23,21,9,9,21,16,4,21,13,16,21,4,9,9,33,28,25,21],[4,1,,,24,,,,24,,,,24,,,,24,,,,24,,,,24,,,,24,,,,24,,,,24,,,,24,,,,24,,,,24,,,,24,,,,24,,,,24,,,,24,,],[4,-1,,,,34,,,,34,,,,34,,,,34,,,,30,,,,34,,,,34,,,15,,,,,34,,,,34,,,,34,,,,34,,,,34,,,,34,,,15,20,,,,,],[,1,,,,,22,,,,,,,,22,,,,,,,,22,,,,,,,,22,,,22,,,,,22,,,,,,,,22,,,,,,,,22,,,,,,,,22,,,22]],[[2,-1,20,,,,,,,,20,,,,,,,,20,,,,,,,,20,,,,,,,,20,,,,,,,,20,,,,,,,,20,,,,,,,,20,,,,,,,,],[1,1,20,,,,,,,,,,,,,,,,,,,,,,,,,,,,13,,,,21,,,,,,,,,,,,,,,,,,,,,,,,25,,,,,,,,],[6,1,13,,13,,13,,13,,13,,13,,13,,13,,13,,13,,13,,13,,13,,13,,13,,13,,9,,9,,9,,9,,9,,9,,9,,9,,9,,9,,9,,9,,9,,9,,9,,9,,],[4,-1,,24,24,24,,24,24,24,,24,24,24,,24,24,24,,24,24,24,,24,24,24,,24,24,24,,24,24,24,,24,24,24,,24,24,24,,24,24,24,,24,24,24,,24,24,24,,24,24,24,,24,24,24,,24,24,24],[5,-1,,,,,22,,,,,,,,22,,,,,,,,22,,,,,,,,22,,,,,,,,22,,,,,,,,22,,,,,,,,22,,,,,,,,22,,,,]]],[0,0,1,1],,{"instruments":["claps1","analogstring","bassdrum2","nice","hihat2","popsnare2","monobass","smash1"],"patterns":["Pattern 0","Pattern 1"]}]);
    const node = window.zzfxP(...buffer);
    node.loop = true;
  </script>
</head>
<body>
  <canvas width="768" height="576" id="app"></canvas>
  <script>
    class ${canvas;emitter;state=new Map;x=0;y=0;constructor(e,t){this.canvas=e,this.emitter=t}onKeyDown=e=>{this.state.set(e.code,!0),e.key===" "&&this.emitter.emit("space")};onKeyUp=e=>{this.state.set(e.code,!1)};onMouseMove=e=>{const t=this.canvas.getBoundingClientRect();this.x=e.clientX-t.left,this.y=e.clientY-t.top};onMouseDown=e=>{e.button===0?this.emitter.emit("mouseDownLeft"):e.button===2&&this.emitter.emit("mouseDownRight")};onMouseUp=e=>{e.button===0?this.emitter.emit("mouseUpLeft"):e.button===2&&this.emitter.emit("mouseUpRight")};onContextMenu=e=>{e.preventDefault()};init(){window.addEventListener("keydown",this.onKeyDown),window.addEventListener("keyup",this.onKeyUp),window.addEventListener("mousedown",this.onMouseDown),window.addEventListener("mouseup",this.onMouseUp),window.addEventListener("contextmenu",this.onContextMenu),this.canvas.addEventListener("mousemove",this.onMouseMove)}dispose(){window.removeEventListener("keydown",this.onKeyDown),window.removeEventListener("keyup",this.onKeyUp),window.removeEventListener("mousedown",this.onMouseDown),window.removeEventListener("mouseup",this.onMouseUp),window.removeEventListener("contextmenu",this.onContextMenu),this.canvas.removeEventListener("mousemove",this.onMouseMove)}}class G{listeners={};on(e,t){return this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t),()=>{this.off(e,t)}}emit(e,...t){if(this.listeners[e])for(const i of this.listeners[e])i(...t)}off(e,t){this.listeners[e]&&(this.listeners[e]=this.listeners[e].filter(i=>i!==t))}}class o{x;y;constructor(e,t){this.x=e,this.y=t}static radian(e){return new o(Math.sin(e),Math.cos(e)).norm()}static random(e){return new o(e.next()*2-1,e.next()*2-1).norm()}add(e){return new o(this.x+e.x,this.y+e.y)}sub(e){return new o(this.x-e.x,this.y-e.y)}equal(e){return this.x===e.x&&this.y===e.y}empty(){return this.equal(new o(0,0))}scale(e){return new o(this.x*e,this.y*e)}dot(e){return this.x*e.x+this.y*e.y}cross(e){return this.x*e.y-this.y*e.x}len(){return Math.hypot(this.x,this.y)}norm(){const e=this.len();return e!==0?new o(this.x/e,this.y/e):new o(0,0)}normal(e){const t=e.sub(this);return new o(-t.y,t.x).norm()}dist(e){return this.sub(e).len()}clone(){return new o(this.x,this.y)}perpendicular(){return new o(-this.y,this.x)}negate(){return this.scale(-1)}reflect(e){return this.sub(e.scale(2*this.dot(e)))}rotate(e){const t=Math.cos(e),i=Math.sin(e);return new o(this.x*t-this.y*i,this.x*i+this.y*t)}}function H(r,e,t,i){const s=i.sub(t),h=r.sub(t),l=Math.max(0,Math.min(1,h.dot(s)/s.dot(s))),a=t.add(s.scale(l));return r.dist(a)<=e}function q(r,e,t){return r.dist(t)<=e}class M{p;d;game;speed;angle=0;c=0;constructor(e,t,i,s=4){this.p=e,this.d=t,this.game=i,this.speed=s}update(){const e=this.game.scene;if(!e)return;this.speed<1.5?this.speed*=.992:this.speed*=.9985;const t=this.p.add(this.d.scale(this.speed));let i=!1;for(const s of e.allEntities)for(const[h,l]of s.lines){if(H(t,4,h,l)){const a=h.normal(l);this.d=this.d.reflect(a).norm(),i=!0}if(q(t,4,h)||q(t,4,l)){const a=t.sub(h).norm();this.d=this.d.reflect(a).norm(),i=!0}}i?(this.speed>.25&&this.game.sound.playEffect("blip"),this.speed*=.95,this.p=this.p.add(this.d.scale(this.speed))):this.p=t,this.c+=1,this.c===10&&(this.c=0,this.speed>.5&&(this.angle=(this.angle+1)%4))}draw(e){const i=this.p.x,s=this.p.y,h=12,l=4;e.save(),e.translate(i,s+6+2),e.scale(1,.6);const a=e.createRadialGradient(0,0,0,0,0,h);a.addColorStop(0,"rgba(0,0,0,0.25)"),a.addColorStop(1,"rgba(0,0,0,0)"),e.fillStyle=a,e.beginPath(),e.ellipse(0,0,h,l,0,0,Math.PI*2),e.fill(),e.restore();const u=this.angle*(Math.PI/2),c=Math.cos(u)*2.5,k=Math.sin(u)*2.5,b=e.createRadialGradient(i+c,s+k,0,i,s,6);b.addColorStop(0,"#ffffff"),b.addColorStop(.25,"#c67575ff"),b.addColorStop(.55,"#781f1fff"),b.addColorStop(1,"#bd2020ff"),e.fillStyle=b,e.beginPath(),e.arc(i,s,6,0,Math.PI*2),e.fill(),e.fillStyle="rgba(255,255,255,0.85)",e.beginPath(),e.arc(i+c,s+k,1,0,Math.PI*2),e.fill()}}class N{game;ball;constructor(e){this.game=e,this.ball=new M(new o(734,46),new o(0,0),e,0)}draw(e){const t=(this.game.scene.timeLeft/1e3).toFixed(2);e.beginPath(),e.fillStyle="#000000",e.fillRect(700,0,60,60),e.font="16px monospace",e.fillStyle="#ffffff",e.fillText(`${t}s`,730,16),this.ball.draw(e),e.fillStyle="#ffffff",e.fillText(`${this.game.player?.balls??0}`,754,40),e.closePath()}}class F{p;w;h;s;hp;dir;game;constructor(e,t,i,s,h,l){this.p=e,this.w=t,this.h=i,this.s=s,this.hp=h,this.game=l,this.dir=new o(0,0)}wouldCollide(e){const t=this.game.scene;if(!t)return!1;for(const i of t.allEntities)if(i.intersect(e,Math.max(this.w,this.h)))return!0;return!1}update(e=!1){if(this.s===0)return;const t=this.dir.scale(this.s),i=this.p.add(new o(t.x,0)),s=this.p.add(new o(0,t.y)),h=this.p.add(t);if(e)if(!this.wouldCollide(h))this.p=h;else{let l=!1;this.wouldCollide(i)||(this.p=i,l=!0),this.wouldCollide(s)||(this.p=s,l=!0),l||(this.p=this.p)}else this.wouldCollide(h)||(this.p=h)}}class X{g;c;i;f;sx;sy;w;h;timer;index;finished=!1;constructor(e,t,i,s,h,l,a,u){this.g=l??0,this.c=h??1,this.i=a??1/0,this.f=u??this.c===1,this.sx=e,this.sy=t,this.w=i,this.h=s,this.timer=0,this.index=0}get x(){return this.sx+this.index*(this.w+this.g)}get y(){return this.sy}reset(){this.timer=0,this.index=0,this.finished=!1}update(e){this.timer+=e,!(this.timer<this.i||this.finished)&&(this.timer=0,this.index=this.index+1,this.index>=this.c&&(this.f?(this.index=this.c-1,this.finished=!0):this.index=0))}}class L{resource;frames;localCanvas;localContext;hi=!1;vi=!1;rotation=0;type;frame;constructor(e,t){this.resource=e,this.frames={};for(const[s,h]of Object.entries(t))this.frames[s]=new X(...h);const i=Object.keys(t)[0];this.type=i,this.frame=this.frames[i],this.localCanvas=document.createElement("canvas"),this.localCanvas.width=this.frame.w,this.localCanvas.height=this.frame.h,this.localContext=this.localCanvas.getContext("2d",{alpha:!0}),this.localContext.imageSmoothingEnabled=!1}play(e){e!==this.type&&(this.type=e,this.frame=this.frames[e],this.frame.reset())}update(e){this.frame.update(e)}rotate(e){this.rotation=Math.atan2(e.y,e.x)}draw(e,t,i,s,h){if(!this.frame)return;const l=this.frame,a=s??l.w,u=h??l.h;this.localCanvas.width=a,this.localCanvas.height=u;const c=this.localContext;c.imageSmoothingEnabled=!1,c.clearRect(0,0,a,u),c.save(),c.translate(a/2|0,u/2|0),c.rotate(this.rotation),this.hi&&this.vi?c.scale(-1,-1):this.hi?c.scale(-1,1):this.vi&&c.scale(1,-1),c.drawImage(this.resource.img,l.x,l.y,l.w,l.h,-a/2|0,-u/2|0,a,u),c.restore(),e.drawImage(this.localCanvas,t-a/2|0,i-u/2|0)}}class z{c;sprite;game;balls=0;isAttacking=!1;constructor(e,t){this.game=t,this.c=new F(e,16,16,2.5,100,t),this.sprite=this.game.sprites.cat}init(){this.game.emitter.on("mouseDownLeft",this.attack),this.game.emitter.on("mouseDownRight",this.throw)}dispose(){this.game.emitter.off("mouseDownLeft",this.attack),this.game.emitter.off("mouseDownRight",this.throw)}attack=()=>{if(!this.isAttacking){this.sprite.play("attack"),this.game.sound.playEffect("hit"),this.isAttacking=!0;const e=this.game.scene?.rats??[];for(const t of e)this.c.p.dist(t.c.p)<30&&(t.c.hp-=25)}};throw=()=>{const e=this.game.scene;if(!e||this.balls===0)return;this.balls-=1,this.game.sound.playEffect("shoot");const t=this.game.control.y,i=this.game.control.x,s=new o(i,t).sub(this.c.p).norm();e.projectiles.push(new M(this.c.p,s,this.game))};update(e){this.updateDirection(),this.updateCharacter(e),this.c.update(!0)}updateDirection(){const e=this.game.control;let t=new o(0,0);e.state.get("KeyW")&&(t=t.add(new o(0,-1))),e.state.get("KeyS")&&(t=t.add(new o(0,1))),e.state.get("KeyA")&&(t=t.add(new o(-1,0))),e.state.get("KeyD")&&(t=t.add(new o(1,0))),this.c.dir=t.norm()}updateCharacter(e){const t=this.game.scene;if(!t)return;let i="idle";this.isAttacking?this.sprite.frame.finished?(this.isAttacking=!1,i=this.c.dir.empty()?"idle":"run"):i="attack":i=this.c.dir.empty()?"idle":"run",this.sprite.play(i),this.c.dir.x<0?this.sprite.hi=!0:this.c.dir.x>0&&(this.sprite.hi=!1);for(let s=0;s<t.projectiles.length;s++){const h=t.projectiles[s];h.p.dist(this.c.p)<=Math.max(this.c.w*2,this.c.h*2)&&h.speed<3&&(t.projectiles.splice(s,1),s-=1,this.game.sound.playEffect("pickup"),this.balls+=1)}this.sprite.update(e)}draw(e){const t=this.c.p;this.sprite.draw(e,t.x,t.y,this.sprite.frame.w*4,this.sprite.frame.h*4),this.game.scene?._debug&&(e.fillStyle="red",e.beginPath(),e.ellipse(t.x,t.y,3,3,Math.PI/4,0,360),e.fill(),e.closePath())}}class J{canvas;context;frameId=-1;fps_timestamp=-1;fps_interval;scene;constructor(e){this.canvas=e,this.context=this.canvas.getContext("2d",{alpha:!1,willReadFrequently:!0});const t=window.devicePixelRatio,i=e.getBoundingClientRect();e.width=i.width*t,e.height=i.height*t,this.context.scale(t,t),e.style.width=`${i.width}px`,e.style.height=`${i.height}px`,this.context.imageSmoothingEnabled=!1,this.fps_interval=1e3/60}tick=()=>{this.frameId=requestAnimationFrame(this.tick);const e=Date.now(),t=e-this.fps_timestamp;t<this.fps_interval||(this.fps_timestamp=e-t%this.fps_interval,this.scene&&(this.scene.update(t),this.scene.draw(this.context)))};start(){this.tick()}}class j{sceneDraw;interactive;entities=[];objects2D=[];projectiles=[];rats=[];gameTime=0;timeLeft=0;t=-1;game;_debug=!1;constructor(e,t=!0,i=0){this.sceneDraw=e,this.gameTime=i,this.interactive=t}*gen(){for(const e of this.entities)yield e;for(const e of this.objects2D)e.entity&&(yield e.entity)}get allEntities(){return[...this.gen()]}update(e){const t=this.game;if(!(!this.interactive||!t)){if(this.timeLeft=(this.gameTime??0)-(Date.now()-t.startTime),this.timeLeft<=0){this.game?.setScene("gameover");return}this.rats.length===0&&this.t===-1&&(t.spentTime+=Date.now()-t.startTime,this.t=setTimeout(()=>{t.nextScene()},1e3)),this.game?.player?.update(e);for(const i of this.entities)i.update(e);for(const i of this.objects2D)i.update(e);for(const i of this.projectiles)i.update();for(let i=0;i<this.rats.length;i++)this.rats[i].update(e),this.rats[i].c.hp<=0&&(this.rats.splice(i,1),i-=1,this.game?.sound.playEffect("death"))}}draw(e){if(this.sceneDraw(e),!!this.interactive){this.game?.panel?.draw(e);for(const t of this.objects2D)t.draw(e);for(const t of this.projectiles)t.draw(e);for(const t of this.rats)t.draw(e);this.game?.player?.draw(e)}}}const n=32,f=32/4,y=n*24,g=n*18,d=y/2,p=g/2,U=r=>{r.font="16px monospace",r.fillStyle="#4d4343",r.fillText("[Press space to skip]",d,g-n*2)},I=(r,e,t=100)=>{const i=r.map(S=>b(S));let s=0,h=0,l=0,a=!1,u=!1,c=0;return function(){if(a)return{done:!0,lines:i[i.length-1]};s+=.18;const S=r[h];l=Math.min(Math.floor(s),r[h].length);const R=k(i[h],l);return u&&(c+=1),l>=S.length&&!u&&(u=!0,c=0),u&&c===t&&(h++,s=0,l=0,u=!1,c=0),h>=r.length&&(a=!0),{done:a,lines:R}};function k(S,R){let D=0;const v=[];for(const P of S)if(D+P.length<R-1)v.push(P),D+=P.length;else{v.push(P.substr(0,R-D));break}return v}function b(S){const R=S.split(" "),D=[];let v="";for(const P of R)v.length+P.length+1>e?(D.push(v),v=P):v+=(v.length===0?"":" ")+P;return v&&D.push(v),D}},Q=r=>{const e=I(["They say black cat brings bad luck","But today the black cat is unlucky","Fulfill your cat duties or face consequences!"],24,50);let t=-1;return new j(s=>{const{lines:h,done:l}=e();l&&t===-1&&(t=setTimeout(()=>{r.order===0&&r.nextScene()},3e3)),s.fillStyle="#000000",s.fillRect(0,0,y,g);const a=120;s.strokeStyle="#ffffff",s.strokeRect(d-n*3,p-n+a,n,n),s.strokeRect(d-n*3,p+f+a,n,n),s.strokeRect(d-n*2+f,p+f+a,n,n),s.strokeRect(d-n*4-f,p+f+a,n,n),s.fillStyle="#fff",s.textBaseline="top",s.textAlign="center",s.font="14px monospace",s.fillText("W",d-n*3+f*2,p-f*3+a),s.fillText("S",d-n*3+f*2,p+f*2+a),s.fillText("A",d-n*4+f,p+f*2+a),s.fillText("D",d-n*2+f*3,p+f*2+a),s.strokeRect(d+50,p-50+a,30,50),s.strokeRect(d+50+30,p-50+a,30,50),s.strokeRect(d+50,p-50+a,60,125),s.fillText("Attack",d+40,p-75+a),s.fillText("Throw",d+120,p-75+a),s.fillStyle="#fff",s.textBaseline="top",s.textAlign="center",s.font="24px monospace";let u=0;for(const c of h)s.fillText(c,d,p-n*4+u),u+=n;U(s)},!1)};class C{p;vs;color;constructor(e,t,i={color:"#000"}){this.p=e,this.vs=t,this.color=i.color}static line(e,t,i){return new C(e,[t,i])}static square(e,t){const i=t/2|0;return new C(e,[new o(-i,-i),new o(i,-i),new o(i,i),new o(-i,i)])}static polygon(e,t,i="#fff"){return new C(e,t.map(([s,h])=>new o(s,h)),{color:i})}*gen(){for(let e=1;e<this.vs.length;e++)yield[this.vs[e-1].add(this.p),this.vs[e].add(this.p)];yield[this.vs[this.vs.length-1].add(this.p),this.vs[0].add(this.p)]}get lines(){return[...this.gen()]}rotate(e){const t=Math.atan2(e.y,e.x);for(let i=0;i<this.vs.length;i++)this.vs[i]=this.vs[i].rotate(t)}move(e){this.p=this.p.add(e)}static lineIntersect(e,t,i){const[s,h]=t,l=h.sub(s),a=e.sub(s),u=l.dot(l);if(u===0)return e.sub(s).len()<=i;const c=a.dot(l)/u,k=Math.max(0,Math.min(1,c)),b=s.add(l.scale(k));return e.sub(b).len()<=i}intersect(e,t=0){for(const i of this.lines)if(C.lineIntersect(e,i,t))return i;return null}draw(e){e.beginPath(),e.setLineDash([]),e.strokeStyle=this.color,e.lineWidth=1;const t=this.vs[0].add(this.p);e.moveTo(t.x,t.y);for(let i=0;i<this.vs.length;i++){const s=this.vs[i].add(this.p);e.lineTo(s.x,s.y)}e.lineTo(t.x,t.y),e.stroke()}update(e){}}class m{position;scale;entity;sprite;frame;finite;hb;hi;vi;constructor(e,t,i,s,h={}){if(this.position=new o(e[0],e[1]),this.sprite=i,this.scale=t,this.frame=s,this.hb=h.hb??!0,this.hi=h.hi??!1,this.vi=h.vi??!1,this.finite=this.sprite.frame.f,this.sprite.play(this.frame),this.hb){const l=this.width/2|0,a=this.height/2|0;this.entity=C.polygon(this.position,[[-l,-a],[l,-a],[l,a],[-l,a]],"red")}}get width(){return this.sprite.frame.w*this.scale}get height(){return this.sprite.frame.h*this.scale}update(e){this.finite||this.sprite.update(e)}draw(e){this.sprite.play(this.frame),this.sprite.hi=this.hi,this.sprite.vi=this.vi,this.sprite.draw(e,this.position.x,this.position.y,this.width,this.height)}}const Z=r=>{const e=I(["You failed to fulfill your duties"],24),t=new j(c=>{if(c.fillStyle="#000000",c.fillRect(0,0,y,g),h?i=Math.max(0,i-2):i=Math.min(200,Math.max(5,i+2)),i===0&&(l=!0),c.fillStyle="#540d0d",c.beginPath(),c.ellipse(d,p,i,i,Math.PI/4,0,360),c.fill("evenodd"),c.closePath(),a.position.x>d?a.position=a.position.add(new o(-1,0)):(a.sprite.play("idle"),s||(s=!0,r.sound.playEffect("jump"))),s&&(u.position=u.position.add(new o(-1,-.5).scale(5))),u.position.x<100&&(h=!0),i>40&&(a.update(16),a.draw(c)),l){const{lines:k}=e();c.fillStyle="#861d1d",c.textBaseline="top",c.textAlign="center",c.font="24px monospace";let b=0;for(const S of k)c.fillText(S,d,p-n+b),b+=n;c.fill()}u.update(16),u.draw(c)},!1);let i=5,s=!1,h=!1,l=!1;const a=new m([y-250,p],3,r.sprites.granny,"run"),u=new m([d-50,p],4,r.sprites.cat,"idle");return t.objects2D=[a,u],t};let A=2023;class K{seed;constructor(e){this.seed=e}static get(){return A=(A+1)%1e4,new K(A)}next(){this.seed=this.seed*16807%2147483647;const e=Math.sin(this.seed)*1e4;return e-Math.floor(e)}}class w{game;c;c1=0;c2=0;sprite;random=K.get();state="run";constructor(e,t,i=2.8){this.game=t,this.c=new F(new o(e[0],e[1]),10,10,i,100,t),this.sprite=new L(t.resources.sprite,{run:[8,34,16,10,10,16,200,!1],death:[8,50,16,10,10,16,100,!0]}),this.c.dir=o.random(this.random),this.state="run",this.sprite.play("run")}update(e){const t=this.game.scene,i=this.game.player;if(!t||!i)return;const s=this.c.p.clone();if(this.c1+=1,this.c1===150&&(this.c.p.dist(i.c.p)<100?this.c.dir=i.c.p.sub(this.c.p).norm().negate():this.random.next()<.5&&(this.c.dir=o.random(this.random)),this.c1=0),this.state==="caught"&&(this.c2+=1),this.c2===250&&(this.state="run",this.sprite.play("run"),this.c2=0),this.state==="run"){for(this.c.update();this.c.p.equal(s);)this.c.dir=o.random(this.random),this.c.update();for(const h of t.projectiles){const l=h.p.dist(this.c.p);if(this.state==="run"&&l<=16&&h.speed>2){this.state="caught",this.sprite.play("death"),this.game.sound.playEffect("stun"),this.c.hp-=10;break}}}this.c.dir.x<0?this.sprite.hi=!1:this.c.dir.x>0&&(this.sprite.hi=!0),this.sprite.update(e)}draw(e){const t=this.c.p.x,i=this.c.p.y;this.sprite.draw(e,t,i,32,20),e.beginPath(),e.fillStyle="red",e.rect(t-10,i-24,32,4),e.fill(),e.closePath(),e.beginPath(),e.fillStyle="green",e.rect(t-10,i-24,32*(this.c.hp/100),4),e.fill(),e.closePath(),this.game.scene?._debug&&(e.fillStyle="red",e.beginPath(),e.ellipse(this.c.p.x,this.c.p.y,3,3,Math.PI/4,0,360),e.fill(),e.closePath())}}const O=(r,e,t)=>{const s=e.sprites.furniture;r.objects2D=[new m([n*4,n*3+f*2],5,s,"kitchen",{hb:!1}),new m([n*8+f,n*5-f],5,s,"wash",{hb:!1}),new m([n*11-f*2+f/2,n*3+f*2],5,s,"fridge",{hb:!1}),new m([n*6,n*10],4,s,"table"),new m([n*3,t===2?g-n*2:g-n*3-f],4,s,"plant"),new m([y-n*6,p-n*3-f*2],4,s,"window",{hb:!1}),new m([y-n*4,p-n*3-f*2],4,s,"window",{hb:!1}),new m([n*5+f,n*11],4,s,"chair2"),new m([n*6+f*3,n*11],4,s,"chair2"),new m([y-n*10,p-n*3],4,s,"door",{hb:!1}),new m([y-n*5,p+f],4,s,"table"),new m([y-n*5,p-f],4,s,"tv",{hb:!1}),new m([y-n*5-f*3,p+n*5],4,s,"chair",{hb:!1}),new m([y-n*5+f*3,p+n*5],4,s,"chair",{hb:!1}),new m([d,t===0?g-n*4+f*2:g-n*3],4,s,"stable")],t>0&&r.objects2D.push(new m([d,g-n*3-f],2,s,"lamp",{hb:!1}),new m([y-n*2+f,g-n*2],2,s,"plant2",{hb:!0}))},Y=(r,e,t)=>{const i=new j(s=>{s.fillStyle="#b0b897",s.fillRect(n,n*6,y-n*2,g-n*7),s.fillStyle="#545046",s.beginPath(),s.rect(0,0,n,g),s.rect(0,0,d,n),s.rect(d,0,n,n*2),s.rect(0,g-n,y,g),s.rect(d,n*2,d,n),s.rect(y-n,n*2,n,g-n*2),s.fill(),s.closePath(),s.beginPath(),s.fillStyle="#6e6244",s.rect(n,n,d-n,n*5),s.fill(),s.closePath(),s.beginPath(),s.fillStyle="#445216",s.rect(d,n*3,d-n,p-n*4),s.fill(),s.closePath(),s.beginPath(),s.fillStyle="#a6b379";for(let h=0;h<22;h++)s.rect(d+h*n/2,n*3,f,164);s.fill(),s.closePath(),s.beginPath(),s.fillStyle="#ffffff",s.rect(n,p-n*3,d-n,f),s.rect(n,p-n*3,f,p+n*2),s.rect(n,g-n-f,y-n*2,f),s.rect(d-f,p-n*3,f,n*2+f),s.rect(d-f,p-n,d-n,f),s.rect(y-n-f,p-n,f,p),s.fill(),s.closePath()},!0,e);return i.entities=[C.polygon(new o(384,360),[[-344,-160],[-8,-160],[-8,-96],[344,-96],[344,176],[-344,176]],"red"),C.polygon(new o(608,448),[[-50,-25],[50,-25],[50,25],[-50,25]],"red")],t(i),i},_=r=>Y(r,9e4,e=>{O(e,r,0),e.projectiles=[new M(new o(56,516),new o(0,0),r,0)],e.rats=[new w([340,340],r,2.5),new w([340,340],r,2.1),new w([80,280],r,2.6),new w([80,280],r,2.8),new w([700,500],r,2.4),new w([700,500],r,2.2)];const t=r.player;return t&&(t.balls=1),e}),x=r=>Y(r,75e3,e=>{O(e,r,1),e.projectiles=[new M(new o(56,516),new o(0,0),r,0),new M(new o(700,290),new o(0,0),r,0),new M(new o(680,480),new o(0,0),r,0)],e.rats=[new w([340,340],r,2.5),new w([340,340],r,2.9),new w([340,340],r,3.1),new w([80,280],r,2.6),new w([80,280],r,2.4),new w([80,280],r,2.8),new w([700,400],r,2.1),new w([700,400],r,2.6)];const t=r.player;return t&&(t.c.p=new o(384,288),t.balls=0),e}),V=r=>Y(r,6e4,e=>{O(e,r,2),e.projectiles=[new M(new o(56,516),new o(0,0),r,0),new M(new o(700,290),new o(0,0),r,0),new M(new o(680,480),new o(0,0),r,0),new M(new o(56,226),new o(0,0),r,0)],e.rats=[new w([340,340],r,2.5),new w([340,340],r,2.9),new w([340,340],r,3.6),new w([340,340],r,3.1),new w([80,280],r,2.6),new w([80,280],r,2.4),new w([80,280],r,2.8),new w([80,280],r,3.5),new w([700,400],r,3.5),new w([700,400],r,3),new w([700,400],r,2.5),new w([700,400],r,2.8)];const t=r.player;return t&&(t.c.p=new o(384,288),t.balls=1),e}),B=(r,e,t)=>{const i=I([`level ${t}`],24);let s=-1;return new j(l=>{l.fillStyle="#000000",l.fillRect(0,0,y,g);const{lines:a,done:u}=i();u&&s===-1&&(s=setTimeout(()=>{r.order===e&&r.nextScene()},1e3)),l.fillStyle="#fff",l.textBaseline="top",l.textAlign="center",l.font="24px monospace",l.fillText(a[0],d,p-n),U(l)},!1)};class ee{musicNode;effects={hit:[,,348,.01,.04,.07,,.3,-6,-14,,,,.9,,.1,,.51,.02,,107],stun:[1.5,,152,,.08,.17,1,.2,-2,,,,,.6,,.2,.08,.92,.02],shoot:[,,79,.01,.04,.06,1,.6,19,-38,,,,,,,,.63,.07],pickup:[,,398,.02,.02,.07,1,1.2,,,208,.06,,,,,,.83,.03],jump:[,,399,.03,.04,,1,2,4,,,,,,,,,.68,.02],blip:[1.1,,207,.02,.02,.04,,1.6,,,267,.28,,.2,133,,,.71,.02],death:[2,,311,.01,.01,.07,,.5,1,14,,,,,,.2,.27,.78,.08,,414]};playEffect(e){window.zzfx(...this.effects[e]??[])}}const te=r=>{const e=I(["You did it!",`You finished your duties in ${(r.spentTime/1e3).toFixed(2)} seconds!`],24);let t=5;const i=new j(h=>{h.fillStyle="#000000",h.fillRect(0,0,y,g);const{lines:l}=e();t=Math.min(200,Math.max(5,t+2)),h.fillStyle="#540d0d",h.beginPath(),h.ellipse(d,p,t,t,Math.PI/4,0,360),h.fill("evenodd"),h.closePath(),h.fillStyle="#000000ff",h.textBaseline="top",h.textAlign="center",h.font="24px monospace";let a=0;for(const u of l)h.fillText(u,d,p-n*2+a),a+=n;s.update(16),s.draw(h)},!1),s=new m([d,p+100],10,r.sprites.cat,"idle");return i.objects2D=[s],i};class se{scenes={};resources={};sprites={};emitter=new G;control;renderer;player;sound=new ee;panel;startTime=0;spentTime=0;scene;s="intro";sceneOrder=["intro","nextlevel0","level0","nextlevel1","level1","nextlevel2","level2","win"];constructor(e){this.renderer=new J(e),this.control=new $(e,this.emitter),this.scene=new j(()=>{},!1)}load(){return Promise.all(Object.values(this.resources).map(e=>e.load()))}get order(){return this.sceneOrder.indexOf(this.s)}nextScene(){if(this.order===-1)return;const e=this.order+1;e>=this.sceneOrder.length||this.setScene(this.sceneOrder[e])}init(){return this.player=new z(new o(384,288),this),this.player.init(),this.control.init(),this.panel=new N(this),this.scenes={intro:()=>Q(this),level0:()=>_(this),level1:()=>x(this),level2:()=>V(this),nextlevel0:()=>B(this,1,1),nextlevel1:()=>B(this,3,2),nextlevel2:()=>B(this,5,3),gameover:()=>Z(this),win:()=>te(this)},this.setScene(this.s),this.emitter.on("space",()=>{const e=this.scene;e&&(e.interactive||this.nextScene())}),Promise.resolve()}setScene(e){this.s=e,this.scene=this.scenes[this.s](),this.scene.game=this,this.renderer.scene=this.scene,this.scene.interactive&&(this.startTime=Date.now())}}class ie{source;loaded=!1;img;constructor(e){this.source=e,this.img=new Image}load(){return new Promise((e,t)=>{this.img.onload=()=>{this.loaded=!0,e()},this.img.onerror=i=>{t(i)},this.img.src=this.source})}}const W=document.getElementById("app");if(!W)throw new Error;const T=new se(W),E=new ie("s.png");T.resources={sprite:E};T.sprites={furniture:new L(E,{fridge:[103,0,15,32],wash:[216,0,16,16],kitchen:[0,61,39,32],table:[55,61,32,16],plant:[180,0,8,12],plant2:[264,0,8,14],window:[188,0,16,32],chair:[64,0,13,13],chair2:[77,0,10,15],door:[87,0,16,32],tv:[232,0,32,16],stable:[39,61,16,15],lamp:[203,0,12,16]}),cat:new L(E,{idle:[2,0,10,6,4,6,250,!1],run:[2,6,10,7,4,6,200,!1],attack:[2,13,12,7,4,4,100,!0]}),granny:new L(E,{idle:[118,0,14,15,1,2,250,!1],run:[118,0,14,15,4,2,200,!1]})};T.load().then(()=>T.init()).then(()=>T.renderer.start());
  </script>
</body>

</html>