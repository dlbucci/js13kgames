async function t(t,s,i=16,h=16){const e=[],n=new Map;for(const o of t){const t=new Image(i,h);t.src=`${s}/${o}.png`,n.set(o,t),e.push(new Promise((s,i)=>{t.onload=()=>s(t),t.onerror=t=>i(t)}))}return await Promise.all(e),n}function s(t){return Math.random()<=t}function i(t,s){return Math.random()*(s-t)+t}function h(t,s,i,h){return!(t<h||s>i)}function e(t){return document.getElementById(t)}const n=class{static t(t,s){return-t+this.y-s}};n.y=0;let o=n;const c=class{};c.ratio=1;let a=c;const r=class{static update(){for(const t of this.i)a.h.fillStyle="#FFF",a.h.fillText(t.text,t.x,o.t(t.y,0))}static o(t,s){this.i.add(t),setTimeout(()=>{this.i.delete(t)},s)}};r.i=new Set;let l=r;class u{constructor(){this.l=0,this.u=performance.now()}p(){this.u=performance.now()}start(t,s,i=0){if(this.l)return t.destroy(),void(this.l=0);const h=(i-this.u)/1e3;this.u=i,a.h.clearRect(0,0,a.c.width,a.c.height),s.update(h),t.update(h),l.update(),requestAnimationFrame(this.start.bind(this,t,s))}stop(){this.l=1}}const f=class s{static async init(){s.m=await async function(){const t=[],s=["1"];for(const i of s){const s=new Image(16,16);s.src=`./assets/obstacles/${i}.png`,t.push(new Promise((t,i)=>{s.onload=()=>t(s),s.onerror=t=>i(t)}))}return Promise.all(t)}(),s.k=await async function(){return await t(["back-cat","side-cat"],"./assets/player")}(),s.M=await async function(){return await t(["human","hat1","hat2","hat3","hat4"],"./assets/human",16,32)}(),s.v=await async function(){return await t(["angry","happy","pockerface","empty"],"./assets/icons",16,16)}(),s.A=await async function(){return await t(["fish"],"./assets/candy",8,5)}()}};f.m=[];let d=f;const p=class{static I(t){for(const s of Object.keys(this))this[s]*=t}};p.T=96,p.D=100,p.O=80,p.C=160,p.A=32;let w=p;class m{constructor(){this.R=0,this.H=0,this.x=0,this.y=0}}class y extends m{constructor(t){super(),this.x=t.x,this.image=t.image,this.K=t.K,this.H=w.D,this.R=w.D}L(){a.h.drawImage(this.image,0,0,16,16,this.x,o.t(this.K.y-this.R/2,this.K.height),this.H,this.R)}}class g{constructor(){this.P=[[1,0,0,1,0,0,0],[0,0,1,0,0,1,0],[1,0,1,0,0,0,0],[0,0,0,0,1,0,1]],this.S=Math.floor(i(0,this.P.length)),this.F=this.P.length-1}W(t){const i=this.P[this.S];let h=0;for(const[e,n]of i.entries()){if(!n)continue;if(s(.4)&&!h){h=1;continue}const i=e*w.D,o=d.m[0];t.Y(new y({x:i,image:o,K:t}))}this.S===this.F?(this.S=0,this.$()):this.S++}$(){for(const t of this.P)t.reverse()}}class b extends m{constructor(t){super(),this.N=0,this.K=t.K,this.direction=t.d,this.s=t.s*a.ratio,this.x=t.x,this.U=d.M.get(`hat${Math.round(i(1,4))}`),this.q=setInterval(this.X.bind(this),750)}X(){if(Math.random()>=.6)return this.N=1,void setTimeout(()=>{this.N=0},2e3);const t=Math.random()>=.5;this.direction=t?-1:1}update(t){if(this.N)return;const s=this.x+this.direction*this.s*t;s>=-this.H&&s<=a.c.offsetWidth&&(this.x=s)}L(t){this.update(t);const s=d.M.get("human");this.H=w.O,this.R=w.C;const i=o.t(this.K.y,this.K.height)-20;a.h.save(),-1===this.direction?(a.h.scale(-1,1),a.h.drawImage(s,0,0,16,32,-this.x-this.H,i,this.H,this.R),a.h.drawImage(this.U,0,0,16,32,-this.x-this.H,i,this.H,this.R)):(a.h.drawImage(s,0,0,16,32,this.x,i,this.H,this.R),a.h.drawImage(this.U,0,0,16,32,this.x,i,this.H,this.R)),a.h.restore()}j(){clearInterval(this.q)}}const k=class{static init(){this.c=document.getElementById("score"),this.G(0)}static G(t,s=0){s?this._=0:this._+=t,this.c.textContent=this._.toString()}static B(){return this._}};k._=0;let x=k;class M extends m{constructor(t,s,i){super(),this.image=d.A.get("fish"),this.J=0,this.duration=.4,this.x=t,this.V=s,this.y=s,this.K=i,this.H=32*a.ratio,this.R=24*a.ratio}L(t){if(this.J<this.duration){this.J+=t;const s=Math.min(this.J/this.duration,1);this.y=this.V+(this.K.y-this.V)*s}else this.y=this.K.y;const s=o.t(this.K.y-this.K.height/2,this.K.height),i=this.y-this.K.y;a.h.drawImage(this.image,0,0,8,5,this.x,s+i,this.H,this.R)}}class v extends m{constructor(t,s){super(),this.m=[],this.Z=[],this.A=null,this.y=s,this.height=t,this.width=a.c.width,this.L(0)}Y(t){this.m.push(t)}tt(t){return null!=this.A&&h(t+w.T,t,this.A.x+w.A,this.A.x)?1:0}st(t){for(const s of this.m)if(h(t+w.T,t,s.x+w.D,s.x))return 1;return 0}it(t){for(const s of this.Z){if(h(t+w.T,t,s.x+w.O,s.x))return 1}return 0}ht(){const t=function(t){let s=Math.random(),i=0;for(let h in t)if(i+=t[h],s<=i)return parseInt(h);return 0}({1:.6,2:.3,3:.1});for(let h=0;h<t;h++)this.Z.push(new b({K:this,d:s(.5)?-1:1,s:i(200,240),x:Math.round(i(-w.O,a.c.offsetWidth))}))}et(){this.A=null}nt(t,s){this.A=new M(t,s,this)}ot(t){let i=0,h=0,e=-1,n=0;for(const r of this.Z){const o=t-r.x;if(o*r.direction<0)continue;const c=Math.abs(o);if(c<=450*a.ratio){i++;const t=100*a.ratio,o=c<=t?150:Math.round(150*Math.exp(-(c-t)/100));o>=100&&s(.4)&&(e=r.x,n=r.K.y+r.K.height+r.R),h+=o}}let o=1;2===i?o=1.25:i>=3&&(o=2);const c=Math.round(h*o);return c>0&&l.o({text:c.toString(),x:t,y:this.y},2e3),x.G(c),[e,n]}L(t){for(const s of this.m)s.L();this.A?.L(t);for(const s of this.Z)s.L(t)}destroy(){for(const t of this.Z)t.j()}}class A{constructor(){this.ct=null,this.rt=1,this.lt=new g,this.rows=[];const t=a.c.height/8;for(let s=0;s<8;s++){const i=new v(t,t*s);s>0&&this.lt.W(i),s>3&&i.ht(),this.rows.push(i)}this.ct=this.rows[0],o.y=a.c.height}ut(t){const s=this.rows[this.rt];if(s.st(t.x))return;if(this.ct=s,t.y=s.y,this.rt<4)return void this.rt++;const i=this.rows[this.rt-1];if(null!=i){const[s,h]=i.ot(t.x);-1!==s&&this.ft(s,h)}const h=this.rows.shift(),e=this.rows[this.rows.length-1],n=e.y+e.height,c=new v(e.height,n);o.y=n+s.height,this.rows.push(c),this.lt.W(c),c.ht(),h.destroy()}update(t){for(const s of this.rows)s.L(t)}ft(t,s){this.rows[this.rt].nt(t,s)}}class I{static init(){this.c=e("lives")}static dt(t){this.c.replaceChildren();let s="happy";t<=3?s="angry":t<=6&&(s="pockerface");for(let i=0;i<9;i++){i+1>t&&(s="empty");const h=d.v.get(s)?.cloneNode();h.classList.add("life"),this.c.appendChild(h)}}}class T{static init(){this.c=e("mobile")}static wt(t,s){this.yt=t,this.gt=s,this.c.addEventListener("touchstart",t),this.c.addEventListener("touchend",s)}static bt(){this.c.removeEventListener("touchstart",this.yt),this.c.removeEventListener("touchend",this.gt),this.gt=null,this.yt=null}}class D extends m{constructor(t,s){super(),this.kt=new Set,this.s=250*a.ratio,this.xt=0,this.Mt=9,this.a=1,this.vt=t,this.At=s,this.H=w.T,this.R=w.T,null!=t.ct&&(this.x=t.ct.width/2-this.H/2,this.y=t.ct.y),T.wt(this.It.bind(this),this.Tt.bind(this)),this.Dt=this.Ot.bind(this),this.Ct=this.Rt.bind(this),document.body.addEventListener("keydown",this.Dt),document.body.addEventListener("keyup",this.Ct),I.dt(this.Mt),this.L()}L(){const t=d.k.get("back-cat"),s=d.k.get("side-cat"),i=o.t(this.y,this.R);a.h.save(),a.h.globalAlpha=this.a,this.kt.has("left")?(a.h.scale(-1,1),a.h.drawImage(s,0,0,16,16,-this.x-this.H,i,this.H,this.R)):this.kt.has("right")?a.h.drawImage(s,0,0,16,16,this.x,i,this.R,this.R):a.h.drawImage(t,0,0,16,16,this.x,i,this.H,this.R),a.h.restore()}update(t){let s=0;this.kt.has("left")?s-=1:this.kt.has("right")&&(s+=1);const i=this.x+s*this.s*t;this.vt.ct?.tt(i)&&(this.vt.ct.et(),this.Mt++,I.dt(this.Mt));const h=this.vt.ct?.st(i);i>=0&&i<=a.c.offsetWidth-this.H&&!h&&(this.x=i),!this.xt&&this.vt.ct?.it(this.x)&&(this.Mt--,0===this.Mt&&(this.At.stop(),O.show()),I.dt(this.Mt),this.xt=1,this.Ht(),setTimeout(()=>{this.a=1,this.xt=0,clearInterval(this.Kt)},1e3)),this.L()}destroy(){document.body.removeEventListener("keydown",this.Dt),document.body.removeEventListener("keyup",this.Ct),T.bt()}Ht(){let t=-.5;this.Kt=setInterval(()=>{this.a+=t,t*=-1},100)}Lt(){this.vt.ut(this)}Tt(t){t.preventDefault(),t.target instanceof HTMLElement&&("left"!==t.target.id&&"right"!==t.target.id||this.kt.delete(t.target.id))}It(t){t.preventDefault(),t.target instanceof HTMLElement&&("left"===t.target.id?this.kt.add("left"):"right"===t.target.id?this.kt.add("right"):this.Lt())}Ot(t){switch(t.code){case"KeyW":case"ArrowUp":this.Lt();break;case"KeyA":case"ArrowLeft":this.kt.add("left");break;case"KeyD":case"ArrowRight":this.kt.add("right")}}Rt(t){switch(t.code){case"KeyA":case"ArrowLeft":this.kt.delete("left");break;case"KeyD":case"ArrowRight":this.kt.delete("right")}}}class O{static init(t){this.c=e("death-screen"),this.c.querySelector("button")?.addEventListener("click",()=>{x.G(0,1);const s=new A,i=new D(s,t);this.hide(),t.p(),t.start(i,s)})}static show(){this.c.style.display="flex",e("final-score").textContent=x.B().toString()}static hide(){this.c.style.display="none"}}class C{constructor(){this.Pt=[{St:"You play as a black cat crossing a Halloween street.",Ft:"50%",top:"50%",c:1},{St:"Move with WASD/Arrows (PC). On mobile, tap left/right or any place on the screen to go up. (Disabled in tutorial)",Ft:"50%",top:"50%",c:1},{St:"Your goal is to earn points by crossing peoples' roads. The closer you are while crossing, the more points!",Ft:"10px",top:"20%"},{St:"Cross close to humans to have a chance of them dropping fish crackers. +1 happiness each!",Ft:"10px",top:"30%"},{St:"Obstacles block path — find another way.",Ft:"10px",top:"40%"},{St:"Your cat starts with 9 happiness. Each time it bumps into a human, it loses 1. At 0, your cat gets annoyed and quits.",Ft:"10px",top:"10%"},{St:"After a bump, you’re briefly invincible — use it!",Ft:"10px",top:"10%"},{St:"That’s it. Good luck! ;)",Ft:"50%",top:"40%",c:1}],this.Wt=0}init(t,s,i){return this.c=e("t"),this.Yt=e("t-window"),this.$t=e("t-text"),this.Yt.querySelector("button")?.addEventListener("click",()=>{if(this.Wt++,this.Wt===this.Pt.length)return this.c.style.display="",void(this.Wt=0);this.Et(this.Wt)}),{start:()=>{this.c.style.display="block",i.start(s,t),this.Et(this.Wt)}}}Et(t){const s=this.Pt[t];this.Yt.style.left=s.Ft,this.Yt.style.top=s.top,this.$t.textContent=s.St,s.c?this.Yt.style.transform="translateX(-50%)":this.Yt.style.transform=""}}class R{static init(t){this.c=e("start-menu");const s=new A,i=new D(s,t);i.L(),s.update(0);const h=(new C).init(s,i,t);e("s").addEventListener("click",()=>{this.hide(),t.p(),t.start(i,s)}),e("t-b").addEventListener("click",()=>{h.start(),this.hide()})}static show(){this.c.style.display="flex"}static hide(){this.c.style.display="none"}}window.addEventListener("DOMContentLoaded",async()=>{const t=new u;O.init(t);const s=e("l");x.init(),I.init(),T.init(),await d.init(),s.remove();const i=e("game");i.width=document.body.offsetWidth,i.height=document.body.offsetHeight;const h=i.getContext("2d");h.imageSmoothingEnabled=0,h.font="32px sans-serif",a.c=i,a.h=h;let n=1;i.width<720&&(n=i.width/720),a.ratio=n,w.I(n),R.init(t)});
