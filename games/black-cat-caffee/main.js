function e(e){return e[Math.floor(Math.random()*e.length)]}var t=class e{constructor(e,t){this.x=e,this.y=t}sub(t){return new e(this.x-t.x,this.y-t.y)}add(t){return new e(this.x+t.x,this.y+t.y)}scale(t){return new e(this.x*t,this.y*t)}len(){return Math.sqrt(this.x**2+this.y**2)}normal(){let t=this.len();return new e(this.x/t,this.y/t)}dot(e){return this.x*e.x+this.y*e.y}distance(e){return Math.sqrt(Math.pow(this.x-e.x,2)+Math.pow(this.y-e.y,2))}perp(){return new e(-this.y,this.x)}set(e){this.x=e.x,this.y=e.y}},s=new t(600,400),n=[[new t(0,155),new t(155,365),new t(240,365),new t(85,155)].map((e=>e.add(s))),[new t(1354,841),new t(1500,841),new t(1200,413),new t(1050,413)]],i=[{pos:new t(1600,1e3),dir:new t(1600,1e3).sub(new t(1190,415))},{pos:new t(0,428),dir:new t(1,0)}].map((e=>({pos:e.pos,dir:e.dir.normal().perp()}))),o=20,a=new t(0,-30);function r(e,t,s,n){return e>s&&e<n?n-e:s>e&&s<t?s-t:null}var l=[];function h({...e}){let s={pos:new t(0,0),...e,anchor:{x:.5,y:1}};return l.push(s),s}function c(e,t){let s=l.filter((s=>s.type==e&&s.pos.distance(t)<g));return 0!=s.length?s.reduce(((e,s)=>e.pos.distance(t)<s.pos.distance(t)?e:s)):null}var p=new t(1190,365),d=new t(1400,660),f=p.distance(d),u=d.sub(p).normal(),g=250;function w(e,t){t.anchor?t.rot?(e.save(),e.translate(t.pos.x-t.anchor.x*t.width,t.pos.y-t.anchor.y*t.height),e.rotate(t.rot),e.drawImage(t.image,0,0,t.width,t.height),e.restore()):e.drawImage(t.image,t.pos.x-t.anchor.x*t.width,t.pos.y-t.anchor.y*t.height,t.width,t.height):e.drawImage(t.image,t.pos.x,t.pos.y,t.width,t.height)}function m(e){return Promise.all(e.map((e=>new Promise((t=>{let s=new Image;s.src=e,s.onload=()=>t(s)})))))}var[y,b,v,x]=await m(["ember.svg","dialog.svg","telecsésze.svg","tej.svg"]),k=[{type:"coffee"},{type:"coffee",tej:1},{type:"coffee",tej:2}],z=210,I=new t(480,700),_=[];var j={update(e){if(this.target&&(this.pos.distance(this.target)>this.speed?(this.pos=this.pos.add(this.target.sub(this.pos).normal().scale(this.speed*e)),0==this.wobble_target?this.wobble_target=.03:.03==Math.abs(this.rot)&&(this.wobble_target*=-1)):(Object.assign(this.pos,this.target),this.target=null,this.wobble_target=0)),Math.abs(this.wobble_target-this.rot)<.005)this.rot=this.wobble_target;else{let e=this.wobble_target-this.rot,t=e/Math.abs(e);this.rot+=.005*t}},additionalRender(e){if("order"==this.state){e.drawImage(b,this.pos.x-this.width/2,this.pos.y+-150-this.height);for(let{image:t,x:s}of this.dialogContent)e.drawImage(t,this.pos.x-this.width/2+s,this.pos.y-this.height-95,50,50)}},calcDialogContent(){let e=this.order.flatMap((e=>{let t=[];if("coffee"===e.type)t.push(v),1==e.tej&&t.push(x),2==e.tej&&(t.push(x),t.push(x));return t})),t=100-(50*e.length+0*(e.length-1))/2;this.dialogContent=e.map(((e,s)=>({image:e,x:t+50*s})))},itemDelivered(e){let t=this.order.findIndex((t=>"coffee"==e.content.type&&"coffee"==t.type&&t.tej==e.content.tej));return-1!=t&&(this.order.splice(t,1),0==this.order.length&&this.done(),!0)},done(){this.state="leave",this.target=new t(-200,1e3),_.splice(_.indexOf(this),1),_.forEach(((e,s)=>e.target=new t(I.x-z*s,I.y)))}};function M(e,t,s){return new Promise((n=>{e.fillStyle="white",e.clearRect(0,0,1600,1e3),e.font="30px monospace",e.fillText(t,800,300),e.font="20px monospace",e.fillText(`press any key to start level ${s}`,800,700),setTimeout((()=>{let e=()=>{document.body.removeEventListener("keydown",e),n()};document.body.addEventListener("keydown",e)}),1e3)}))}Array.prototype.remove=function(e){let t=this.indexOf(e);-1!=t&&this.splice(t,1)};var C={};onkeydown=e=>C[e.key]="press"==C[e.key]||"hold"==C[e.key]?"hold":"press",onkeyup=e=>C[e.key]=null;var T=document.getElementsByTagName("canvas")[0].getContext("2d");T.fillStyle="white",T.textAlign="center";var E=!0,[R,D,O,q,A,L,P,S,B,F,N,U,Y,$,G]=await m(["macska.svg","hatter.svg","elso_counter.svg","csésze.svg","telecsésze.svg","interact.svg","telifőzőcsésze.svg","féligtelifőzőcsésze.svg","üresfőzőcsésze.svg","kávéfőző.svg","kávéfőzőcsésze.svg","kávéfőzőcsészeteli.svg","kávéfőzőfej.svg","gőz1.svg","tej.svg"]),H=(()=>{let e=document.createElement("canvas");e.width=100,e.height=100;let t=e.getContext("2d");t.save(),t.translate(100,0),t.scale(-1,1),t.drawImage($,0,0,100,100),t.restore();let s=new Image;return s.src=e.toDataURL(),s})(),J=7,K=.04,Q=.007,V={image:R,pos:new t(500,500),anchor:{x:.6,y:1},width:100,height:100,rot:0,wobble_target:0},W={image:D,pos:new t(0,0),width:1600,height:1e3},X={image:O,pos:new t(600,769),anchor:{x:0,y:1},width:241,height:369},Z={image:L,anchor:{x:.5,y:1.4},pos:new t(0,0),width:100,height:100},ee=!1,te=new t(600,400),se=5e3,ne=500,ie=new t(1150,300),oe=new t(1100,150),ae=0,re=1100,le=250,he=118.5144,ce=88.567*1.2,pe=125.832,de=null,fe=!1,ue=0;var ge=h({image:B,width:67,height:67,type:"főzőcsésze",fill:"none"});ge.pos=new t(1200,400);var we=h({image:G,width:70,height:70,type:"tej"});we.pos=new t(1300,600);var me,ye=[],be=15e3,ve=1,xe=1;function ke(){je=[V,ge,we],me=ve,setTimeout(ze,1e3),setTimeout(Ie,2e4),E=!0,qe(performance.now())}function ze(){if(0==me)return;me-=1;let s=function(){let s=I.x-z*_.length,n=Object.create(j);return n.pos=new t(-300,500),n.width=200,n.height=400,n.image=y,n.anchor={x:.5,y:1},n.target=new t(s,I.y),n.speed=4,n.state="order",n.order=[e(k)],n.left=!1,n.dialogContent=[],n.calcDialogContent(),n.rot=0,n.wobble_target=0,_.push(n),n}();ye.push(s),je.push(s),E&&setTimeout(ze,be)}function Ie(){if(ye.length>0){let e=ye.length-1;for(;e>-1;)"leave"==ye[e].state&&null==ye[e].target&&ye.splice(e,1),e-=1;0==ye.length&&0==me?_e():setTimeout(Ie,5e3)}else 0==me&&_e()}async function _e(){E=!1,be*=.9,ve+=3,xe+=1,await M(T,"You finished level "+(xe-1),xe),ke()}var je,Me,Ce,Te=new t(930,300);function Ee(){if(Ce)if(Ce==ge){if(V.pos.distance(ie)<g&&null==de)return Z.pos=ie,ee=!0,void(Me={type:"place-főzőcsésze"});if("full"==ge.fill||"half"==ge.fill){let e=c("cup",V.pos);if(e)return Z.pos=e.pos,ee=!0,void(Me={type:"pour-coffee",item:e})}}else if(Ce==we){let e=c("coffee",V.pos);if(e&&(e.content.tej<2||null==e.content.tej))return Z.pos=e.pos,ee=!0,void(Me={type:"pour-milk",item:e})}else{let e=ye.filter((e=>e.pos.distance(V.pos)<g));if(0!=e.length)return e=ye.reduce(((e,t)=>e.pos.distance(V.pos)<t.pos.distance(V.pos)?e:t)),Me={type:"give-item",npc:e},void(ee=!1)}else{if(null!=de&&V.pos.distance(ie)<g&&!fe)return Z.pos=ie,ee=!0,void(Me={type:"take-főzőcsésze"});if(V.pos.distance(Te)<200)return Z.pos=Te,ee=!0,void(Me={type:"cupboard"});let e=function(e){let t=l.filter((t=>t.pos.distance(e)<g));return 0!=t.length?t.reduce(((t,s)=>t.pos.distance(e)<s.pos.distance(e)?t:s)):null}(V.pos);if(e)return Z.pos=e.pos,ee=!0,void(Me={type:"pickup",item:e})}ee=!1,Me=null}function Re(e){(function(e){let t=l.indexOf(e);if(t==l.length-1)l.pop();else if(-1!=t){let e=l.pop();l[t]=e}})(e),Ce=e}function De(){let e=Ce;return Ce=null,e}var Oe=performance.now();function qe(e){if(!E)return;let t=(e-Oe)/16.6666||1;Oe=e;for(let e of ye)e.update(t);(function(e){if(C.w&&(V.pos.y-=J*e),C.s&&(V.pos.y+=J*e),C.a&&(V.pos.x-=J*e),C.d&&(V.pos.x+=J*e),C.w||C.s||C.a||C.d?0==V.wobble_target?V.wobble_target=K:Math.abs(V.rot)==K&&(V.wobble_target*=-1):V.wobble_target=0,Math.abs(V.wobble_target-V.rot)<Q)V.rot=V.wobble_target;else{let e=V.wobble_target-V.rot,t=e/Math.abs(e);V.rot+=Q*t}!function(e){let t=e.add(a);for(let s of n){let n=null,i=[],a=s[s.length-1];for(let e=0;e<s.length;e++){let t=s[e],n=t.sub(a).perp().normal();i.push(n),a=t}for(let e=0;e<s.length;e++){let a=1/0,l=-1/0;for(let t of s){let n=t.sub(s[e]).dot(i[e]);n>l&&(l=n),n<a&&(a=n)}let h=t.sub(s[e]).dot(i[e]),c=r(a,l,h-o,h+o);if(!c){n=null;break}(!n||n.len()>Math.abs(c))&&(n=i[e].scale(-c))}n&&e.set(e.add(n))}for(let s of i){let n=t.sub(s.pos).dot(s.dir)-o;n<0&&e.set(e.add(s.dir.scale(-n)))}}(V.pos)})(t),Ee(),"press"==C.q&&function(){if(Ce){let e=function(e){let t,s=e.sub(p).dot(u);return t=s<0?p:s>f?d:p.add(u.scale(s)),t.distance(e)<g?t:null}(V.pos);if(e){let t=De();t.pos=e,je.push(t),function(e){l.push(e)}(t)}}}(),"press"==C.e&&function(){if(Me)switch(Me.type){case"pickup":je.remove(Me.item),Re(Me.item);break;case"cupboard":Re(h({image:q,width:50,height:50,type:"cup",content:{}}));break;case"place-főzőcsésze":{let e=De();de=e,ue=1,fe=!0;let t=setInterval((()=>{ae=0==ae?1:0}),ne);setTimeout((()=>{fe=!1,ue=2,e.fill="full",e.image=P,clearInterval(t)}),se);break}case"take-főzőcsésze":ue=0,Re(de),de=null;break;case"pour-coffee":{let e=Ce,t=Me.item;switch(e.fill){case"full":e.image=S,e.fill="half";break;case"half":e.image=B,e.fill="none"}t.image=A,t.type="coffee",t.content={type:"coffee"};break}case"give-item":Me.npc.itemDelivered(Ce)&&De();break;case"pour-milk":Me.item.content.tej=(Me.item.content.tej??0)+1}}(),function(){for(let e in C)"press"==C[e]&&(C[e]="hold")}(),T.fillStyle="black",T.clearRect(0,0,1600,1e3),w(T,W),function(){switch(T.drawImage(F,re,le,he,ce),ue){case 0:break;case 1:T.drawImage(N,re,le,pe,ce);break;case 2:T.drawImage(U,re,le,pe,ce)}T.drawImage(Y,re,le,he,ce)}(),je.sort(Le).forEach((e=>{e==V?V.pos.y>X.pos.y||!(V.pos.y<X.pos.y-200)&&function(e){let t=(e.y-Se.y)/Pe.y,s=Se.x+t*Pe.x;return e.x-s}(V.pos)<0?(w(T,X),Ae(),w(T,V)):(w(T,V),Ae(),w(T,X)):(w(T,e),e.additionalRender&&e.additionalRender(T))})),fe&&(0==ae?T.drawImage($,oe.x,oe.y,100,100):T.drawImage(H,oe.x,oe.y,100,100)),ee&&w(T,Z),requestAnimationFrame(qe)}function Ae(){Ce&&(Ce.pos=V.pos.add(new t(-5,-100)),w(T,Ce))}function Le(e,t){return e.pos.y-t.pos.y}var Pe=new t(155,365).add(te).sub(new t(0,155).add(te)),Se=new t(0,155).add(te);await M(T,"Black Cat Caffee",1),ke();